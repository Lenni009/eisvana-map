if(glMatrix.setMatrixArrayType(Array),vec3.fromXYZ=function(t){var e=new Array(3);return e[0]=t.x,e[1]=t.y,e[2]=t.z,e},vec3.toXYZ=function(t){return{x:t[0],y:t[1],z:t[2]}},vec4.fromXYZ=function(t,e){var i=new Array(4);return i[0]=t.x,i[1]=t.y,i[2]=t.z,i[3]=e,i},mat4.fromYPR=function(t,e,i){var r=new Array(16),o=Math.sin(i),a=Math.cos(i),n=Math.sin(e),s=Math.cos(e),l=Math.sin(t),c=Math.cos(t);return r[0]=c*a,r[4]=-c*o,r[8]=l,r[1]=n*l*a+s*o,r[5]=s*a-n*l*o,r[9]=-n*c,r[2]=n*o-s*l*a,r[6]=n*a+s*l*o,r[10]=s*c,r[3]=0,r[7]=0,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1,r},quat.fromYPR=function(t,e,i){var r=.5*i,o=Math.sin(r),a=Math.cos(r),n=.5*e,s=Math.sin(n),l=Math.cos(n),c=.5*t,h=Math.sin(c),u=Math.cos(c),d=new Array(4);return d[0]=u*s*a+h*l*o,d[1]=h*l*a-u*s*o,d[2]=u*l*o-h*s*a,d[3]=u*l*a+h*s*o,d},void 0===Phoria||!Phoria){var Phoria={};Phoria.RADIANS=Math.PI/180,Phoria.TWOPI=2*Math.PI,Phoria.ONEOPI=1/Math.PI,Phoria.PIO2=Math.PI/2,Phoria.PIO4=Math.PI/4,Phoria.EPSILON=1e-6}Phoria.Util={},Phoria.Util.extend=function(t,e,i){var r,o=function(){};if(o.prototype=e.prototype,t.prototype=new o,t.prototype.constructor=t,t.superclass=e.prototype,e.prototype.constructor==Object.prototype.constructor&&(e.prototype.constructor=e),i)for(r in i)i.hasOwnProperty(r)&&(t.prototype[r]=i[r])},Phoria.Util.augment=function(t,e){for(var i in e.prototype)void 0===t.prototype[i]&&(t.prototype[i]=e.prototype[i])},Phoria.Util.merge=function(t,e){var i=Array.isArray(e),r=i&&[]||{};return i?(t=t||[],r=r.concat(t),e.forEach((function(e,i){r[i]="object"==typeof e?Phoria.Util.merge(t[i],e):e}))):(t&&"object"==typeof t&&Object.keys(t).forEach((function(e){r[e]=t[e]})),Object.keys(e).forEach((function(i){"object"==typeof e[i]&&e[i]&&t&&t[i]?r[i]=Phoria.Util.merge(t[i],e[i]):r[i]=e[i]}))),r},Phoria.Util.combine=function(t,e){Array.isArray(e)&&Array.isArray(t)?(t.length<e.length&&(t.length=e.length),e.forEach((function(e,i){"object"==typeof e?(t[i]=t[i]||{},Phoria.Util.combine(t[i],e)):t[i]=e}))):Object.keys(e).forEach((function(i){"object"==typeof e[i]&&e[i]?(t[i]=t[i]||(Array.isArray(e[i])?[]:{}),Phoria.Util.combine(t[i],e[i])):t[i]=e[i]}))},Phoria.Util.clone=function(t){var e=null,i={};for(var r in t)e=t[r],Array.isArray(e)?i[r]=[].concat(e):i[r]=e;return i},Phoria.Util.isIdentity=function(t){return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]},Phoria.Util.calcNormalVector=function(t,e,i,r,o,a){var n=vec4.fromValues(e*a-i*o,-(a*t-r*i),t*o-e*r,0);return vec3.normalize(n,n)},Phoria.Util.thetaTo=function(t,e){return Math.acos(vec3.dot(t,e)/(Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])*Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])))},Phoria.Util.averagePolyVertex=function(t,e){for(var i=0,r=0,o=0,a=0;i<t.length;i++)r+=e[t[i]][0],o+=e[t[i]][1],a+=e[t[i]][2];return vec3.fromValues(r/t.length,o/t.length,a/t.length)},Phoria.Util.averageObjectZ=function(t){for(var e=0,i=0;i<t.length;i++)e+=t[i][3];return e/t.length},Phoria.Util.populateBuffer=function(t,e){for(var i=new Array(t),r=0;r<t;r++)i[r]=e(r);return i},Phoria.Util.sortPolygons=function(t,e){for(var i,r=0;r<t.length;r++)3===(i=t[r].vertices).length?t[r]._avz=.333333*(e[i[0]][2]+e[i[1]][2]+e[i[2]][2]):t[r]._avz=.25*(e[i[0]][2]+e[i[1]][2]+e[i[2]][2]+e[i[3]][2]);t.sort((function(t,e){return t._avz<e._avz?-1:1}))},Phoria.Util.sortEdges=function(t,e){for(var i=0;i<t.length;i++)t[i]._avz=.5*(e[t[i].a][2]+e[t[i].b][2]);t.sort((function(t,e){return t._avz<e._avz?-1:1}))},Phoria.Util.sortPoints=function(t,e){!function t(e,i,r,o){if(r<o){var a=r+o>>1,n=i[a][2],s=r,l=i[a];i[a]=i[o],i[o]=l,l=e[a],e[a]=e[o],e[o]=l;for(var c=r;c<o;c++)i[c][2]>n&&(l=e[c],e[c]=e[s],e[s]=l,l=i[c],i[c]=i[s],i[s]=l,s++);l=e[s],e[s]=e[o],e[o]=l,l=i[s],i[s]=i[o],i[o]=l,t(e,i,r,s-1),t(e,i,s+1,o)}}(e,t,0,t.length-1)},Phoria.Util.generateTesselatedPlane=function(t,e,i,r,o){for(var a,n=[],s=[],l=[],c=r/e,h=r/t,u=0,d=0,v=r/2;d<=t;d++){a=-r/2;for(var y=0;y<=e;y++){if(n.push({x:a,y:0,z:v}),0!==y&&s.push({a:u,b:u-1}),0!==d&&s.push({a:u,b:u-e-1}),0!==d&&0!==y){var f={vertices:[u-e-1,u,u-1,u-e-2]};if(o){var m=[1/e*y,1/t*(d-1),1/e*y,1/t*d,1/e*(y-1),1/t*d,1/e*(y-1),1/t*(d-1)];f.uvs=m}l.push(f)}a+=c,u++}v-=h}return{points:n,edges:s,polygons:l}},Phoria.Util.generateUnitCube=function(t){var e=t||1;return{points:[{x:-1*e,y:1*e,z:-1*e},{x:1*e,y:1*e,z:-1*e},{x:1*e,y:-1*e,z:-1*e},{x:-1*e,y:-1*e,z:-1*e},{x:-1*e,y:1*e,z:1*e},{x:1*e,y:1*e,z:1*e},{x:1*e,y:-1*e,z:1*e},{x:-1*e,y:-1*e,z:1*e}],edges:[{a:0,b:1},{a:1,b:2},{a:2,b:3},{a:3,b:0},{a:4,b:5},{a:5,b:6},{a:6,b:7},{a:7,b:4},{a:0,b:4},{a:1,b:5},{a:2,b:6},{a:3,b:7}],polygons:[{vertices:[0,1,2,3]},{vertices:[1,5,6,2]},{vertices:[5,4,7,6]},{vertices:[4,0,3,7]},{vertices:[4,5,1,0]},{vertices:[3,2,6,7]}]}},Phoria.Util.generatePyramid=function(t){var e=t||1;return{points:[{x:-1*e,y:0,z:-1*e},{x:-1*e,y:0,z:1*e},{x:1*e,y:0,z:1*e},{x:1*e,y:0*e,z:-1*e},{x:0,y:1.5*e,z:0}],edges:[{a:0,b:1},{a:1,b:2},{a:2,b:3},{a:3,b:0},{a:0,b:4},{a:1,b:4},{a:2,b:4},{a:3,b:4}],polygons:[{vertices:[0,1,4]},{vertices:[1,2,4]},{vertices:[2,3,4]},{vertices:[3,0,4]},{vertices:[3,2,1,0]}]}},Phoria.Util.generateIcosahedron=function(t){var e=t||1,i=(1+Math.sqrt(5))/2,r=i/Math.sqrt(1+i*i)*e,o=1/Math.sqrt(1+i*i)*e;return{points:[{x:r,y:o,z:0},{x:-r,y:o,z:0},{x:-r,y:-o,z:0},{x:r,y:-o,z:0},{x:o,y:0,z:r},{x:o,y:0,z:-r},{x:-o,y:0,z:-r},{x:-o,y:0,z:r},{x:0,y:r,z:o},{x:0,y:-r,z:o},{x:0,y:-r,z:-o},{x:0,y:r,z:-o}],edges:[{a:4,b:8},{a:8,b:7},{a:7,b:4},{a:7,b:9},{a:9,b:4},{a:5,b:6},{a:6,b:11},{a:11,b:5},{a:5,b:10},{a:10,b:6},{a:0,b:4},{a:4,b:3},{a:3,b:0},{a:3,b:5},{a:5,b:0},{a:2,b:7},{a:7,b:1},{a:1,b:2},{a:1,b:6},{a:6,b:2},{a:8,b:0},{a:0,b:11},{a:11,b:8},{a:11,b:1},{a:1,b:8},{a:9,b:10},{a:10,b:3},{a:3,b:9},{a:9,b:2},{a:2,b:10}],polygons:[{vertices:[4,8,7]},{vertices:[4,7,9]},{vertices:[5,6,11]},{vertices:[5,10,6]},{vertices:[0,4,3]},{vertices:[0,3,5]},{vertices:[2,7,1]},{vertices:[2,1,6]},{vertices:[8,0,11]},{vertices:[8,11,1]},{vertices:[9,10,3]},{vertices:[9,2,10]},{vertices:[8,4,0]},{vertices:[11,0,5]},{vertices:[4,9,3]},{vertices:[5,3,10]},{vertices:[7,8,1]},{vertices:[6,1,11]},{vertices:[7,2,9]},{vertices:[6,10,2]}]}},Phoria.Util.subdivide=function(t,e){for(var i,r=[],o=[],a=function(t){var e=t.x*t.x+t.y*t.y+t.z*t.z;e=1/Math.sqrt(e),t.x*=e,t.y*=e,t.z*=e},n=function(t,e,i){var n={x:0,y:0,z:0},s={x:0,y:0,z:0},l={x:0,y:0,z:0};n.x=t.x+e.x,n.y=t.y+e.y,n.z=t.z+e.z,s.x=e.x+i.x,s.y=e.y+i.y,s.z=e.z+i.z,l.x=i.x+t.x,l.y=i.y+t.y,l.z=i.z+t.z,a(n),a(s),a(l);var c=r.length;r.push(t,e,i,n,s,l),o.push({vertices:[c+0,c+3,c+5]}),o.push({vertices:[c+1,c+4,c+3]}),o.push({vertices:[c+2,c+5,c+4]}),o.push({vertices:[c+3,c+4,c+5]})},s=0;s<e.length;s++)3===(i=e[s].vertices).length?n.call(this,t[i[0]],t[i[1]],t[i[2]]):4===i.length&&(n.call(this,t[i[0]],t[i[1]],t[i[2]]),n.call(this,t[i[2]],t[i[3]],t[i[0]]));return{points:r,polygons:o}},Phoria.Util.generateCylinder=function(t,e,i){for(var r=[],o=[],a=[],n=2*Math.PI/i,s=0,l=0;s<=i;s++)if(r.push({x:Math.cos(l)*t,z:Math.sin(l)*t,y:e/2}),r.push({x:Math.cos(l)*t,z:Math.sin(l)*t,y:-e/2}),l+=n,0!==s&&(o.push({vertices:[2*s-2,2*s,2*s+1,2*s-1]}),a.push({a:2*s,b:2*s-2},{a:2*s-2,b:2*s-1},{a:2*s+1,b:2*s-1}),s===i-1)){for(var c=[],h=i;h>=0;h--)c.push(2*h);for(o.push({vertices:c}),c=[],h=0;h<i;h++)c.push(2*h+1);o.push({vertices:c})}return{points:r,edges:a,polygons:o}},Phoria.Util.generateCuboid=function(t){var e=t.scalex||1,i=t.scaley||1,r=t.scalez||1;return t.offsetx,t.offsety,t.offsetz,{points:[{x:-1*e,y:1*i,z:-1*r},{x:1*e,y:1*i,z:-1*r},{x:1*e,y:-1*i,z:-1*r},{x:-1*e,y:-1*i,z:-1*r},{x:-1*e,y:1*i,z:1*r},{x:1*e,y:1*i,z:1*r},{x:1*e,y:-1*i,z:1*r},{x:-1*e,y:-1*i,z:1*r}],edges:[{a:0,b:1},{a:1,b:2},{a:2,b:3},{a:3,b:0},{a:4,b:5},{a:5,b:6},{a:6,b:7},{a:7,b:4},{a:0,b:4},{a:1,b:5},{a:2,b:6},{a:3,b:7}],polygons:[{vertices:[0,1,2,3]},{vertices:[0,4,5,1]},{vertices:[1,5,6,2]},{vertices:[2,6,7,3]},{vertices:[4,0,3,7]},{vertices:[5,4,7,6]}]}},Phoria.Util.generateSphere=function(t,e,i,r){for(var o=[],a=[],n=[],s=[],l=0;l<=e;++l)for(var c=0;c<=i;++c){var h=l*Math.PI/e,u=2*c*Math.PI/i,d=Math.sin(h),v=Math.sin(u),y=Math.cos(h),f=Math.cos(u)*d,m=y,p=v*d;if(r){var g=c/i,P=l/e;s.push({u:g,v:P})}o.push({x:t*f,y:t*m,z:t*p})}for(l=0;l<e;++l)for(c=0;c<i;++c){var x=l*(i+1)+c,b=x+i+1;if(0===l){var w={vertices:[x+1,b+1,b]};r&&(w.uvs=[s[x+1].u,s[x+1].v,s[b+1].u,s[b+1].v,s[b].u,s[b].v]),n.push(w),a.push({a:x,b:b})}else l===e-1?(w={vertices:[x+1,b,x]},r&&(w.uvs=[s[x+1].u,s[x+1].v,s[b].u,s[b].v,s[x].u,s[x].v]),n.push(w),a.push({a:x,b:b})):(w={vertices:[x+1,b+1,b,x]},r&&(w.uvs=[s[x+1].u,s[x+1].v,s[b+1].u,s[b+1].v,s[b].u,s[b].v,s[x].u,s[x].v]),n.push(w),a.push({a:x,b:b}),a.push({a:b,b:b+1}))}return{points:o,edges:a,polygons:n}},Phoria.Util.generateRadialGradientBitmap=function(t,e,i){var r=document.createElement("canvas"),o=t<<1;r.width=r.height=o;var a=r.getContext("2d"),n=a.createRadialGradient(t,t,t>>1,t,t,t);n.addColorStop(0,e),n.addColorStop(1,i),a.fillStyle=n,a.fillRect(0,0,o,o);var s=new Image;return s.src=r.toDataURL("image/png"),s},Phoria.Util.request=function(t){var e=new XMLHttpRequest,i=t.data||"";t.responseContentType&&e.overrideMimeType&&e.overrideMimeType(t.responseContentType),e.open(t.method?t.method:"GET",t.url),t.requestContentType&&e.setRequestHeader("Accept",t.requestContentType),e.onreadystatechange=function(){4===e.readyState&&(200===e.status?t.fnSuccess&&t.fnSuccess.call(this,e.responseText,e.status):t.fnFailure?t.fnFailure.call(this,e.responseText,e.status):alert(e.status+"\n\n"+e.responseText))};try{"POST"===t.method||"PUT"===t.method?e.send(i):e.send(null)}catch(t){alert(t.message)}},Phoria.Util.importGeometryWavefront=function(t){var e,i,r,o,a,n,s=[],l=[],c=[],h=/\s+/,u=t.scale||1;e=i=r=o=a=n=0,Phoria.Util.request({url:t.url,fnSuccess:function(d){for(var v=d.split("\n"),y=0;y<v.length;y++){var f=v[y].split(h);switch(f[0]){case"v":var m=parseFloat(f[1])*u,p=parseFloat(f[2])*u,g=parseFloat(f[3])*u;s.push({x:m,y:p,z:g}),m<e?e=m:m>o&&(o=m),p<i?i=p:p>a&&(a=p),g<r?r=g:g>n&&(n=g);break;case"vt":var P=parseFloat(f[1]),x=parseFloat(f[2]);c.push([P,x]);break;case"f":f.splice(0,1);for(var b,w,M=[],_=[],z=0;z<f.length;z++)if(0!==(b=f[t.reorder?f.length-z-1:z]).length&&(w=b.split("/"),M.push(parseInt(w[0])-1),w.length>1&&-1===b.indexOf("//"))){var E=parseInt(w[1])-1;c.length>E&&_.push(c[E][0],c[E][1])}var S={vertices:M};l.push(S),0!==_.length&&(S.uvs=_)}}if(t.center){var R=(e+o)/2,U=(i+a)/2,A=(r+n)/2;for(y=0;y<s.length;y++)s[y].x-=R,s[y].y-=U,s[y].z-=A}if(t.scaleTo){var V=o-e,k=a-i,T=n-r,H=0;for(H=k>V?T>k?1/(T/t.scaleTo):1/(k/t.scaleTo):T>V?1/(T/t.scaleTo):1/(V/t.scaleTo),y=0;y<s.length;y++)s[y].x*=H,s[y].y*=H,s[y].z*=H}t.fnSuccess&&t.fnSuccess.call(this,{points:s,polygons:l})},fnFailure:function(e){t.fnFailure&&t.fnFailure.call(this,e)}})},Phoria.Util.calculatePolarFromPlanar=function(t){var e=new vec3.create;return e[0]=vec3.length(t),e[1]=Math.acos(t[2]/e[0]),0!==t[0]?t[0]>0?e[2]=Math.atan(t[1]/t[0]):e[2]=Math.PI+Math.atan(t[1]/t[0]):t[1]>0?e[2]=Math.PI/2:e[2]=3*Math.PI/2,e},Phoria.Util.calculatePlanarFromPolar=function(t){return new vec3.fromValues(Math.round(t[0]*Math.sin(t[1])*Math.cos(t[2])*100)/100,Math.round(t[0]*Math.sin(t[1])*Math.sin(t[2])*100)/100,Math.round(t[0]*Math.cos(t[1])*100)/100)},Phoria.Util.planeLineIntersection=function(t,e,i,r){var o=vec3.dot(i,t);if(0!==o){var a=new vec3.create;vec3.subtract(a,e,r);var n=vec3.dot(t,a)/o,s=vec3.create();return vec3.scaleAndAdd(s,r,i,n),s}return null},Phoria.Util.intersectionInsidePolygon=function(t,e,i){for(var r=vec3.fromValues(Math.abs(t._worldnormal[0]),Math.abs(t._worldnormal[1]),Math.abs(t._worldnormal[2])),o=0,a=vec2.fromValues(1,1),n=0;n<t.vertices.length;n++){var s,l,c;r[2]>=r[0]&&r[2]>=r[1]?(s=vec2.fromValues(e[t.vertices[n]][0],e[t.vertices[n]][1]),l=n<t.vertices.length-1?vec2.fromValues(e[t.vertices[n+1]][0],e[t.vertices[n+1]][1]):vec2.fromValues(e[t.vertices[0]][0],e[t.vertices[0]][1]),c=vec2.fromValues(i[0],i[1])):r[1]>r[0]?(s=vec2.fromValues(e[t.vertices[n]][2],e[t.vertices[n]][0]),l=n<t.vertices.length-1?vec2.fromValues(e[t.vertices[n+1]][2],e[t.vertices[n+1]][0]):vec2.fromValues(e[t.vertices[0]][2],e[t.vertices[0]][0]),c=vec2.fromValues(i[2],i[0])):(s=vec2.fromValues(e[t.vertices[n]][1],e[t.vertices[n]][2]),l=n<t.vertices.length-1?vec2.fromValues(e[t.vertices[n+1]][1],e[t.vertices[n+1]][2]):vec2.fromValues(e[t.vertices[0]][1],e[t.vertices[0]][2]),c=vec2.fromValues(i[1],i[2])),Phoria.Util.sectionLineIntersect2D(s,l,c,a)&&o++}return o%2==1},Phoria.Util.sectionLineIntersect2D=function(t,e,i,r){var o=vec2.create();vec2.subtract(o,e,t);var a=vec3.create();if(vec2.cross(a,o,r),0===a[2])return!1;var n,s=(i[0]*r[1]-i[1]*r[0]-t[0]*r[1]+t[1]*r[0])/a[2];n=0!==r[0]?(t[0]+s*o[0]-i[0])/r[0]:(t[1]+s*o[1]-i[1])/r[1];var l=vec2.create();vec2.scaleAndAdd(l,t,o,s);var c={x:!1,y:!1};return n>=0&&(t[0]>e[0]?l[0]<=t[0]&&l[0]>=e[0]&&(c.x=!0):l[0]>=t[0]&&l[0]<=e[0]&&(c.x=!0),t[1]>e[1]?l[1]<=t[1]&&l[1]>=e[1]&&(c.y=!0):l[1]>=t[1]&&l[1]<=e[1]&&(c.y=!0)),c.x&&c.y},Phoria.Preloader=function(){return this.images=[],this},Phoria.Preloader.prototype={images:null,callback:null,counter:0,addImage:function(t,e){var i=this;t.url=e,t.onload=function(){i.counter++,i.counter===i.images.length&&i.callback.call(i)},this.images.push(t)},onLoadCallback:function(t){this.counter=0,this.callback=t;for(var e=0,i=this.images.length;e<i;e++)this.images[e].src=this.images[e].url}},Phoria.Scene=function(){return this.camera={up:{x:0,y:1,z:0},lookat:{x:0,y:0,z:0},position:{x:0,y:0,z:-10}},this.perspective={fov:35,aspect:1,near:1,far:1e4},this.viewport={x:0,y:0,width:1024,height:1024},this.graph=[],this.triggerHandlers=[],this},Phoria.Scene.create=function(t){var e=new Phoria.Scene;return t.camera&&(e.camera=Phoria.Util.merge(e.camera,t.camera)),t.perspective&&(e.perspective=Phoria.Util.merge(e.perspective,t.perspective)),t.viewport&&(e.viewport=Phoria.Util.merge(e.viewport,t.viewport)),t.graph&&(e.graph=t.graph),t.onCamera&&e.onCamera(t.onCamera),e},Phoria.Scene.createFromJSON=function(t){var e=JSON.parse(t);if(e&&e.graph){var i=function(t){for(var e,r=0;r<t.length;r++)for(var o in e=t[r])e.hasOwnProperty(o)&&(0===o.indexOf("on")&&(e[o]instanceof string||e[o]),"children"===o&&e[o]instanceof Array&&i(e[o]))};i(e.graph)}return null},Phoria.Scene.toJSON=function(t){for(var e in t)t.hasOwnProperty(e)&&0===e.indexOf("_")&&delete t[e];if(t.graph){var i=function(t){for(var e,r=0;r<t.length;r++)for(var o in e=t[r])if(e.hasOwnProperty(o))switch(0===o.indexOf("on")&&e[o]instanceof Array&&(e[o]=e[o].toString()),0===o.indexOf("_")&&delete e[o],o){case"textures":delete e[o];break;case"children":e[o]instanceof Array&&i(e[o])}};i(t.graph)}return JSON.stringify(t)},Phoria.Scene.prototype={camera:null,perspective:null,graph:null,viewport:null,renderlist:null,lights:null,triggerHandlers:null,onCameraHandlers:null,_entities:null,_lastTime:0,_cameraPosition:null,_perspectiveScale:0,findEntity:function(t){return this._entities[t]},onCamera:function(t){null===this.onCameraHandlers&&(this.onCameraHandlers=[]),this.onCameraHandlers=this.onCameraHandlers.concat(t)},modelView:function(){var t=Date.now(),e=(t-this._lastTime)/1e3;this._lastTime=t;var i=this.viewport.x,r=this.viewport.y,o=.5*this.viewport.width,a=.5*this.viewport.height;this._cameraPosition=vec4.fromValues(this.camera.position.x,this.camera.position.y,this.camera.position.z,0);var n=mat4.create(),s=vec4.fromValues(this.camera.lookat.x,this.camera.lookat.y,this.camera.lookat.z,0),l=vec4.fromValues(this.camera.up.x,this.camera.up.y,this.camera.up.z,0);if(null!==this.onCameraHandlers)for(var c=0;c<this.onCameraHandlers.length;c++)this.onCameraHandlers[c].call(this,this._cameraPosition,s,l);mat4.lookAt(n,this._cameraPosition,s,l);var h=mat4.create();mat4.perspective(h,-this.perspective.fov*Phoria.RADIANS,this.perspective.aspect,this.perspective.near,this.perspective.far),this._perspectiveScale=(256-this.perspective.fov)/16;var u=[],d=[],v={},y=function(t,s){for(var l,c,f=0;f<t.length;f++)if(!(l=t[f]).disabled){if(l.id&&(v[l.id]=l),null!==l.onBeforeSceneHandlers)for(var m=0;m<l.onBeforeSceneHandlers.length;m++)l.onBeforeSceneHandlers[m].call(l,this,e);var p=l.matrix;if(s&&(p=p?mat4.multiply(mat4.create(),p,s):s),null!==l.onSceneHandlers)for(m=0;m<l.onSceneHandlers.length;m++)l.onSceneHandlers[m].call(l,this,p,e);if(l instanceof Phoria.BaseLight)d.push(l);else if(l instanceof Phoria.Entity){c=l.points.length,l.initCoordinateBuffers();var g=0,P=0;"point"===l.style.drawmode&&(P=0===l.style.linescale?.5*l.style.linewidth:l.style.linewidth*l.style.linescale/this._perspectiveScale*.5);for(var x,b,w,M=0,_=0;M<c;M++)x=l.points[M],b=vec4.set(l._worldcoords[M],x.x,x.y,x.z,1),p&&vec4.transformMat4(l._worldcoords[M],b,p),vec4.transformMat4(l._cameracoords[M],l._worldcoords[M],n),vec4.transformMat4(l._coords[M],l._cameracoords[M],h),0===(w=(b=l._coords[M])[3])&&(w=Phoria.EPSILON),g+=l._clip[M]=b[0]>w+P||b[0]<-w-P||b[1]>w+P||b[1]<-w-P||b[2]>w||b[2]<-w?1:0,b[0]/=w,b[1]/=w,b[0]=o*b[0]+i+o,b[1]=a*b[1]+r+a,_+=b[2];if(l._averagez=c>1?_/c:_,g!==c){if(l.style.geometrysortmode,"sorted"===l.style.geometrysortmode||"solid"===l.style.drawmode||"lightsource"===l.style.shademode)switch(l.style.drawmode){case"solid":Phoria.Util.sortPolygons(l.polygons,l._cameracoords);break;case"wireframe":Phoria.Util.sortEdges(l.edges,l._cameracoords);break;case"point":Phoria.Util.sortPoints(l._coords,l._worldcoords)}if("solid"===l.style.drawmode&&0!==l.polygons.length){var z=mat4.invert(mat4.create(),p||mat4.create());if(mat4.transpose(z,z),"lightsource"===l.style.shademode)for(var E,S,R=0;R<l.polygons.length;R++)l.polygons[R]._worldnormal||(l.polygons[R]._worldnormal=vec4.create()),E=l.polygons[R].normal,S=l.polygons[R]._worldnormal,vec3.transformMat4(S,E,z),vec3.normalize(S,S)}u.push(l)}}l.children&&0!==l.children.length&&y.call(this,l.children,p)}};y.call(this,this.graph,null),this.renderlist=u,this.lights=d,this._entities=v;for(var f=0,m=this.triggerHandlers.length;f<m;f++)this.triggerHandlers[f].trigger.call(this,this._cameraPosition,s,l)&&(this.triggerHandlers.splice(f,1),m--)}},Phoria.BaseEntity=function(){return this.matrix=mat4.create(),this.children=[],this},Phoria.BaseEntity.create=function(t,e){return e||(e=new Phoria.BaseEntity),t.id&&(e.id=t.id),t.matrix&&(e.matrix=t.matrix),t.children&&(e.children=t.children),t.onBeforeScene&&e.onBeforeScene(t.onBeforeScene),t.onScene&&e.onScene(t.onScene),void 0!==t.disabled&&(e.disabled=t.disabled),e},Phoria.BaseEntity.prototype={id:null,children:null,matrix:null,disabled:!1,onBeforeSceneHandlers:null,onSceneHandlers:null,onBeforeScene:function(t){null===this.onBeforeSceneHandlers&&(this.onBeforeSceneHandlers=[]),this.onBeforeSceneHandlers=this.onBeforeSceneHandlers.concat(t)},onScene:function(t){null===this.onSceneHandlers&&(this.onSceneHandlers=[]),this.onSceneHandlers=this.onSceneHandlers.concat(t)},identity:function(){return mat4.identity(this.matrix),this},invert:function(){return mat4.invert(this.matrix,this.matrix),this},multiply:function(t){return mat4.multiply(this.matrix,this.matrix,t),this},scale:function(t){return mat4.scale(this.matrix,this.matrix,t),this},scaleN:function(t){return mat4.scale(this.matrix,this.matrix,vec3.fromValues(t,t,t)),this},rotate:function(t,e){return mat4.rotate(this.matrix,this.matrix,t,e),this},rotateX:function(t){return mat4.rotateX(this.matrix,this.matrix,t),this},rotateY:function(t){return mat4.rotateY(this.matrix,this.matrix,t),this},rotateZ:function(t){return mat4.rotateZ(this.matrix,this.matrix,t),this},rotateYPR:function(t,e,i){var r=mat4.fromYPR(t,e,i);mat4.multiply(this.matrix,this.matrix,r)},translate:function(t){return mat4.translate(this.matrix,this.matrix,t),this},translateX:function(t){return mat4.translate(this.matrix,this.matrix,vec3.fromValues(t,0,0)),this},translateY:function(t){return mat4.translate(this.matrix,this.matrix,vec3.fromValues(0,t,0)),this},translateZ:function(t){return mat4.translate(this.matrix,this.matrix,vec3.fromValues(0,0,t)),this},determinant:function(){return mat4.determinant(this.matrix)},transpose:function(){return mat4.transpose(this.matrix,this.matrix),this}},Phoria.CLIP_ARRAY_TYPE="undefined"!=typeof Uint32Array?Uint32Array:Array,Phoria.Entity=function(){return Phoria.Entity.superclass.constructor.call(this),this.points=[],this.edges=[],this.polygons=[],this.textures=[],this.style=Phoria.Entity.createStyle(),this},Phoria.Entity.create=function(t,e){return e||(e=new Phoria.Entity),Phoria.BaseEntity.create(t,e),t.points&&(e.points=t.points),t.polygons&&(e.polygons=t.polygons),t.edges&&(e.edges=t.edges),t.style&&Phoria.Util.combine(e.style,t.style),t.onRender&&e.onRender(t.onRender),e.generatePolygonNormals(),e},Phoria.Entity.createStyle=function(t){var e={color:[128,128,128],diffuse:1,specular:0,drawmode:"solid",shademode:"lightsource",fillmode:"inflate",objectsortmode:"sorted",geometrysortmode:"automatic",linewidth:1,linescale:0,opacity:1,doublesided:!1};return t&&Phoria.Util.combine(e,t),e},Phoria.Util.extend(Phoria.Entity,Phoria.BaseEntity,{points:null,edges:null,polygons:null,style:null,textures:null,onRenderHandlers:null,_worldcoords:null,_cameracoords:null,_coords:null,_clip:null,_averagez:0,_sorted:!0,onRender:function(t){null===this.onRenderHandlers&&(this.onRenderHandlers=[]),this.onRenderHandlers=this.onRenderHandlers.concat(t)},generatePolygonNormals:function(){if(this.polygons)for(var t,e,i,r,o,a,n,s=this.points,l=this.polygons,c=0;c<l.length;c++)e=s[(t=l[c].vertices)[1]].x-s[t[0]].x,i=s[t[1]].y-s[t[0]].y,r=s[t[1]].z-s[t[0]].z,o=s[t[2]].x-s[t[0]].x,a=s[t[2]].y-s[t[0]].y,n=s[t[2]].z-s[t[0]].z,l[c].normal=Phoria.Util.calcNormalVector(e,i,r,o,a,n)},initCoordinateBuffers:function(){var t=this.points.length;if(null===this._worldcoords||this._worldcoords.length<t){this._worldcoords=new Array(t);for(var e=0;e<t;e++)this._worldcoords[e]=vec4.create()}if(null===this._cameracoords||this._cameracoords.length<t)for(this._cameracoords=new Array(t),e=0;e<t;e++)this._cameracoords[e]=vec4.create();if(null===this._coords||this._coords.length<t)for(this._coords=new Array(t),e=0;e<t;e++)this._coords[e]=vec4.create();(null===this._clip||this._clip.length<t)&&(this._clip=new Phoria.CLIP_ARRAY_TYPE(t))},getScreenBounds:function(){for(var t,e=1e4,i=1e4,r=-1e4,o=-1e4,a=0;a<this._coords.length;a++)(t=this._coords[a])[0]<e&&(e=t[0]),t[0]>r&&(r=t[0]),t[1]<i&&(i=t[1]),t[1]>o&&(o=t[1]);return{minx:e,miny:i,maxx:r,maxy:o}},getWorldBounds:function(){for(var t,e=1e4,i=1e4,r=1e4,o=-1e4,a=-1e4,n=-1e4,s=0;s<this._worldcoords.length;s++)(t=this._worldcoords[s])[0]<e&&(e=t[0]),t[0]>o&&(o=t[0]),t[1]<i&&(i=t[1]),t[1]>a&&(a=t[1]),t[2]<r&&(r=t[2]),t[2]>n&&(n=t[2]);return{minx:e,miny:i,maxx:o,maxy:a,minz:r,maxz:n}}}),Phoria.Entity.debug=function(t,e){for(var i="Phoria.Debug"+(t.id?" "+t.id:""),r=null,o=0;o<t.children.length;o++)if(t.children[o].id===i){r=t.children[o];break}if(null===r){(r=new Phoria.Entity).id=i,r.points=[{x:0,y:0,z:0}],r.style={drawmode:"point",shademode:"callback",geometrysortmode:"none",objectsortmode:"front"},r.config={},r.onRender((function(e,i,o){null==this.config.fillStyle?e.fillStyle="#333":e.fillStyle=this.config.fillStyle,e.font="14pt Helvetica";var a=o;if(this.config.showId&&(e.fillText(t.id?t.id:"unknown - set Entity 'id' property",i,a),a+=16),this.config.showPosition){var n=t.worldposition?t.worldposition:r._worldcoords[0];e.fillText("{x:"+n[0].toFixed(2)+", y:"+n[1].toFixed(2)+", z:"+n[2].toFixed(2)+"}",i,a)}})),t.children.push(r);var a=function(t,e,i){var r=new Phoria.Entity;return r.points=[{x:0,y:0,z:0},{x:2*e[0],y:2*e[1],z:2*e[2]}],r.edges=[{a:0,b:1}],r.style={drawmode:"wireframe",shademode:"plain",geometrysortmode:"none",objectsortmode:"front",linewidth:2,color:i},r.disabled=!0,r};r.children.push(a(0,vec3.fromValues(1,0,0),[255,0,0])),r.children.push(a(0,vec3.fromValues(0,1,0),[0,255,0])),r.children.push(a(0,vec3.fromValues(0,0,1),[0,0,255]))}for(Phoria.Util.combine(r.config,e),o=0;o<r.children.length;o++)r.children[o].disabled=!r.config.showAxis},Phoria.PositionalAspect={},Phoria.PositionalAspect.prototype={position:null,worldposition:null,updatePosition:function(t){var e=vec4.fromXYZ(this.position,1);vec4.transformMat4(e,e,t),this.worldposition=e}},Phoria.PhysicsEntity=function(){return Phoria.PhysicsEntity.superclass.constructor.call(this),this.velocity={x:0,y:0,z:0},this.position={x:0,y:0,z:0},this._force={x:0,y:0,z:0},this._acceleration=null,this.gravity=!0,this.onBeforeScene(this.applyPhysics),this.onScene(this.transformToScene),this},Phoria.PhysicsEntity.create=function(t){var e=new Phoria.PhysicsEntity;return Phoria.Entity.create(t,e),t.velocity&&(e.velocity=t.velocity),t.position&&(e.position=t.position),t.force&&(e._force=t.force),void 0!==t.gravity&&(e.gravity=t.gravity),e},Phoria.Util.extend(Phoria.PhysicsEntity,Phoria.Entity,{velocity:null,gravity:!1,_force:null,_acceleration:null,impulse:function(t){this._acceleration=t},force:function(t){this._force=t},applyPhysics:function(t){var e=1e3/60/1e3,i=e*e;this._acceleration&&(this.velocity.x+=this._acceleration.x*i,this.velocity.y+=this._acceleration.y*i,this.velocity.z+=this._acceleration.z*i,this._acceleration=null),this._force&&(this.velocity.x+=this._force.x*i,this.velocity.y+=this._force.y*i,this.velocity.z+=this._force.z*i),this.gravity&&(this.velocity.x+=Phoria.PhysicsEntity.GRAVITY.x*i,this.velocity.y+=Phoria.PhysicsEntity.GRAVITY.y*i,this.velocity.z+=Phoria.PhysicsEntity.GRAVITY.z*i),this.translate(vec3.fromXYZ(this.velocity))},transformToScene:function(t,e){this.updatePosition(e)}}),Phoria.Util.augment(Phoria.PhysicsEntity,Phoria.PositionalAspect),Phoria.PhysicsEntity.GRAVITY={x:0,y:-9.8,z:0},Phoria.EmitterEntity=function(){Phoria.EmitterEntity.superclass.constructor.call(this),this.position={x:0,y:0,z:0},this.positionRnd={x:0,y:0,z:0},this.velocity={x:0,y:1,z:0},this.velocityRnd={x:0,y:0,z:0},this.maximum=1e3,this.gravity=!0;var t=Phoria.Entity.createStyle();return t.drawmode="point",t.shademode="plain",t.geometrysortmode="none",t.linewidth=5,t.linescale=2,this.style=t,this.textures=[],this._lastEmitTime=Date.now(),this.onScene(this.emitParticles),this},Phoria.EmitterEntity.create=function(t){var e=new Phoria.EmitterEntity;return Phoria.BaseEntity.create(t,e),t.position&&(e.position=t.position),t.positionRnd&&(e.positionRnd=t.positionRnd),t.rate&&(e.rate=t.rate),t.maximum&&(e.maximum=t.maximum),t.velocity&&(e.velocity=t.velocity),t.velocityRnd&&(e.velocityRnd=t.velocityRnd),t.lifetime&&(e.lifetime=t.lifetime),t.lifetimeRnd&&(e.lifetimeRnd=t.lifetimeRnd),void 0!==t.gravity&&(e.gravity=t.gravity),t.style&&Phoria.Util.combine(e.style,t.style),t.onParticle&&e.onParticle(t.onParticle),e},Phoria.Util.extend(Phoria.EmitterEntity,Phoria.BaseEntity,{style:null,rate:0,maximum:0,velocity:null,velocityRnd:null,lifetime:0,lifetimeRnd:0,gravity:!1,_lastEmitTime:0,onParticleHandlers:null,onParticle:function(t){null===this.onParticleHandlers&&(this.onParticleHandlers=[]),this.onParticleHandlers=this.onParticleHandlers.concat(t)},emitParticles:function(t,e,i){this.updatePosition(e);for(var r,o=Date.now(),a=0;a<this.children.length;a++)(r=this.children[a])._gravetime&&o>r._gravetime&&this.children.splice(a,1);var n=o-this._lastEmitTime,s=Math.floor(this.rate/1e3*n);if(s>0){for(var l=0;l<s&&(0===this.maximum||this.children.length<this.maximum);l++){var c={x:this.position.x,y:this.position.y,z:this.position.z};c.x+=Math.random()*this.positionRnd.x-.5*this.positionRnd.x,c.y+=Math.random()*this.positionRnd.y-.5*this.positionRnd.y,c.z+=Math.random()*this.positionRnd.z-.5*this.positionRnd.z;var h={x:this.velocity.x,y:this.velocity.y,z:this.velocity.z};h.x+=Math.random()*this.velocityRnd.x-.5*this.velocityRnd.x,h.y+=Math.random()*this.velocityRnd.y-.5*this.velocityRnd.y,h.z+=Math.random()*this.velocityRnd.z-.5*this.velocityRnd.z;var u=new Phoria.PhysicsEntity;if(u.position=c,u.points=[c],u.velocity=h,u.gravity=this.gravity,u.style=this.style,u.textures=this.textures,0!==this.lifetime&&(u._gravetime=Math.floor(o+this.lifetime+this.lifetimeRnd*Math.random()-.5*this.lifetimeRnd)),null!==this.onParticleHandlers)for(var d=0;d<this.onParticleHandlers.length;d++)this.onParticleHandlers[d].call(this,u);this.children.push(u)}this._lastEmitTime=o}}}),Phoria.Util.augment(Phoria.EmitterEntity,Phoria.PositionalAspect),Phoria.BaseLight=function(){return Phoria.BaseLight.superclass.constructor.call(this),this.color=[1,1,1],this.intensity=1,this},Phoria.Util.extend(Phoria.BaseLight,Phoria.BaseEntity,{color:null,intensity:0}),Phoria.DistantLight=function(){return Phoria.DistantLight.superclass.constructor.call(this),this.direction={x:0,y:0,z:1},this.onScene(this.transformToScene),this},Phoria.DistantLight.create=function(t){var e=new Phoria.DistantLight;return Phoria.BaseEntity.create(t,e),t.color&&(e.color=t.color),t.intensity&&(e.intensity=t.intensity),t.direction&&(e.direction=vec3.toXYZ(vec3.normalize(e.direction,vec3.fromXYZ(t.direction)))),e},Phoria.Util.extend(Phoria.DistantLight,Phoria.BaseLight,{direction:null,worlddirection:null,transformToScene:function(){this.worlddirection=vec3.fromValues(-this.direction.x,-this.direction.y,-this.direction.z)}}),Phoria.PointLight=function(){return Phoria.PointLight.superclass.constructor.call(this),this.position={x:0,y:0,z:-1},this.attenuation=.1,this.attenuationFactor="linear",this.onScene(this.transformToScene),this},Phoria.PointLight.create=function(t){var e=new Phoria.PointLight;return Phoria.BaseEntity.create(t,e),t.color&&(e.color=t.color),t.intensity&&(e.intensity=t.intensity),t.position&&(e.position=t.position),t.attenuation&&(e.attenuation=t.attenuation),t.attenuationFactor&&(e.attenuationFactor=t.attenuationFactor),e},Phoria.Util.extend(Phoria.PointLight,Phoria.BaseLight,{attenuation:0,attenuationFactor:null,transformToScene:function(t,e,i){this.updatePosition(e)}}),Phoria.Util.augment(Phoria.PointLight,Phoria.PositionalAspect),Phoria.Renderer=function(){},Phoria.Renderer.prototype={sort:!0,sortObjects:function(t){if(this.sort){for(var e,i=0;i<t.renderlist.length;i++)switch((e=t.renderlist[i]).style.objectsortmode){case"sorted":break;case"front":e._averagez=Number.MIN_VALUE;break;default:e._averagez=Number.MAX_VALUE}t.renderlist.sort((function(t,e){return t._averagez<e._averagez?1:-1}))}},calcNormalBrightness:function(t,e,i,r){for(var o,a,n=[0,0,0],s=i.lights,l=0;l<s.length;l++){if((o=s[l])instanceof Phoria.DistantLight){if((h=vec3.dot(e,o.worlddirection))<=0)continue;a=h*o.intensity*r.style.diffuse}else if(o instanceof Phoria.PointLight){var c,h,u=vec3.subtract(vec3.create(),t,o.worldposition),d=vec3.length(u);if(vec3.normalize(u,u),(h=vec3.dot(e,vec3.negate(u,u)))<=0)continue;switch(o.attenuationFactor){default:case"none":c=o.attenuation;break;case"linear":c=o.attenuation*d;break;case"squared":c=o.attenuation*d*d}if(0!==r.style.specular){var v=vec3.add(vec3.create(),u,i._cameraPosition),y=vec3.dot(e,vec3.normalize(v,v)),f=Math.pow(y,r.style.specular)*o.intensity/c;n[0]+=f*o.color[0],n[1]+=f*o.color[1],n[2]+=f*o.color[2]}a=r.style.diffuse*h*o.intensity/c}n[0]+=a*o.color[0],n[1]+=a*o.color[1],n[2]+=a*o.color[2]}return n},calcPositionBrightness:function(t,e){for(var i,r,o=[0,0,0],a=0;a<e.length;a++){if((i=e[a])instanceof Phoria.DistantLight)r=i.intensity;else if(i instanceof Phoria.PointLight){var n,s=vec3.subtract(vec3.create(),t,i.worldposition),l=vec3.length(s);switch(vec3.normalize(s,s),i.attenuationFactor){case"linear":n=i.attenuation*l;break;case"squared":n=i.attenuation*l*l;break;default:n=i.attenuation}r=i.intensity/(2*n)}o[0]+=r*i.color[0],o[1]+=r*i.color[1],o[2]+=r*i.color[2]}return o},inflatePolygon:function(t,e,i){i=i||.5;for(var r=new Array(t.length),o=0;o<t.length;o++)r[o]=[e[t[o]][0],e[t[o]][1]];o=0;for(var a,n,s,l=t.length;o<l;o++){a=o<l-1?o+1:0,n=r[o][0],s=r[o][1];var c,h=r[a][0]-n,u=r[a][1]-s,d=h*h+u*u;0===d&&Phoria.EPSILON,h*=c=i/Math.sqrt(d),u*=c,r[o][0]-=h,r[o][1]-=u,r[a][0]+=h,r[a][1]+=u}return r},inflatePolygonFull:function(t,e,i){i=i||.5;for(var r,o,a,n,s,l,c,h=[],u=new Array(t.length),d=0,v=t.length;d<v;d++)r=e[t[d]][0],o=e[t[d]][1],d<v-1?(a=e[t[d+1]][0],n=e[t[d+1]][1]):(a=e[t[0]][0],n=e[t[0]][1]),s=n-o,l=-(a-r),s/=c=Math.sqrt(s*s+l*l),l/=c,s*=i,l*=i,h.push({x:r+s,y:o+l}),h.push({x:a+s,y:n+l});var y;for(d=0,v=t.length;d<v;d++)y=0===d?this.intersection(h[2*(v-1)],h[2*(v-1)+1],h[0],h[1]):this.intersection(h[2*(d-1)],h[2*(d-1)+1],h[2*d],h[2*d+1]),(Math.abs(y[0]-e[t[d]][0])>1.5||Math.abs(y[1]-e[t[d]][1])>1.5)&&(y[0]=e[t[d]][0],y[1]=e[t[d]][1]),u[d]=y;return u},intersection:function(t,e,i,r){var o=e.x-t.x,a=i.x-r.x,n=i.x-t.x,s=e.y-t.y,l=i.y-r.y,c=(a*(i.y-t.y)-l*n)/(s*a-o*l);return[t.x+c*(e.x-t.x),t.y+c*(e.y-t.y)]}},Phoria.CanvasRenderer=function(t){return Phoria.CanvasRenderer.superclass.constructor.call(this),this.canvas=t,this.ctx=t.getContext("2d"),this},Phoria.Util.extend(Phoria.CanvasRenderer,Phoria.Renderer,{canvas:null,ctx:null,render:function(t,e){this.sortObjects(t);var i=this.ctx;e?e.call(this,i):i.clearRect(0,0,this.canvas.width,this.canvas.height);for(var r,o=0;o<t.renderlist.length;o++){switch(r=t.renderlist[o],i.save(),r.style.compositeOperation&&(i.globalCompositeOperation=r.style.compositeOperation),r.style.drawmode){case"solid":"fillstroke"!==r.style.fillmode&&"hiddenline"!==r.style.fillmode||(i.lineWidth=1);for(var a=0;a<r.polygons.length;a++)this.renderPolygon(i,r,t,r.polygons[a]);break;case"wireframe":if(i.lineWidth=r.style.linewidth,i.globalAlpha=r.style.opacity,"plain"===r.style.shademode){for(i.strokeStyle="rgb("+r.style.color[0]+","+r.style.color[1]+","+r.style.color[2]+")",i.beginPath(),a=0;a<r.edges.length;a++)this.renderEdge(i,r,t,r.edges[a]);i.closePath(),i.stroke()}else for(a=0;a<r.edges.length;a++)this.renderEdge(i,r,t,r.edges[a]);break;case"point":if("sprite"===r.style.shademode&&void 0!==r.style.sprite){if(!r.textures)throw new Error("Entity has shademode 'sprite' but no textures defined on parent emitter.");if(r.style.sprite>r.textures.length-1)throw new Error("Entity has shademode 'sprite' index but references missing texture on parent emitter.")}i.globalAlpha=r.style.opacity;var n=r._coords;for("plain"===r.style.shademode&&(i.fillStyle="rgb("+r.style.color[0]+","+r.style.color[1]+","+r.style.color[2]+")"),a=0;a<n.length;a++)this.renderPoint(i,r,t,n[a],a)}i.restore()}},renderPoint:function(t,e,i,r,o){if(!e._clip[o]){var a=e.style.linewidth;switch(0!==e.style.linescale&&(a=e.style.linewidth*e.style.linescale*i._perspectiveScale/e._coords[o][3]),e.style.shademode){case"plain":t.beginPath(),t.arc(r[0],r[1],a,0,Phoria.TWOPI,!0),t.closePath(),t.fill();break;case"sprite":void 0!==e.style.sprite&&t.drawImage(e.textures[e.style.sprite],r[0]-a,r[1]-a,a+a,a+a);break;case"callback":if(null!==e.onRenderHandlers)for(var n=0;n<e.onRenderHandlers.length;n++)e.onRenderHandlers[n].call(e,t,r[0],r[1],a);break;case"lightsource":var s=this.calcPositionBrightness(e._worldcoords[o],i.lights);t.fillStyle="rgb("+Math.min(Math.ceil(s[0]*e.style.color[0]),255)+","+Math.min(Math.ceil(s[1]*e.style.color[1]),255)+","+Math.min(Math.ceil(s[2]*e.style.color[2]),255)+")",t.beginPath(),t.arc(r[0],r[1],a,0,Phoria.TWOPI,!0),t.closePath(),t.fill()}}},renderEdge:function(t,e,i,r){if(!(e._clip[r.a]&e._clip[r.b])){var o=e._coords;if(0!==e.style.linescale&&(t.lineWidth=e.style.linewidth*e.style.linescale/(.5*(e._coords[r.a][3]+e._coords[r.b][3]))*i._perspectiveScale),"lightsource"===e.style.shademode){var a=e._worldcoords[r.a],n=e._worldcoords[r.b],s=vec3.fromValues(.5*(a[0]+n[0]),.5*(a[1]+n[1]),.5*(a[2]+n[2])),l=this.calcPositionBrightness(s,i.lights);t.beginPath(),t.strokeStyle="rgb("+Math.min(Math.ceil(l[0]*e.style.color[0]),255)+","+Math.min(Math.ceil(l[1]*e.style.color[1]),255)+","+Math.min(Math.ceil(l[2]*e.style.color[2]),255)+")",t.moveTo(o[r.a][0],o[r.a][1]),t.lineTo(o[r.b][0],o[r.b][1]),t.closePath(),t.stroke()}else t.moveTo(o[r.a][0],o[r.a][1]),t.lineTo(o[r.b][0],o[r.b][1])}},renderPolygon:function(t,e,i,r){for(var o,a=e._coords,n=e._clip,s=r.vertices,l=r.color?r.color:e.style.color,c=null,h=0,u=r.opacity?r.opacity:e.style.opacity,d=1,v=0;v<s.length;v++)d&=n[s[v]];if(!d&&(e.style.doublesided||!(a[s[0]][0]*a[s[1]][1]-a[s[1]][0]*a[s[0]][1]+(a[s[1]][0]*a[s[2]][1]-a[s[2]][0]*a[s[1]][1])+(a[s[2]][0]*a[s[0]][1]-a[s[0]][0]*a[s[2]][1])<0))){switch(e.style.shademode){case"plain":void 0===e.style.texture&&void 0===r.texture&&(c=l[0]+","+l[1]+","+l[2]);break;case"lightsource":o=this.calcNormalBrightness(Phoria.Util.averagePolyVertex(s,e._worldcoords),r._worldnormal,i,e),(r.emit||e.style.emit)&&(h=r.emit?r.emit:e.style.emit),c=Math.min(Math.ceil(o[0]*l[0]+l[0]*h),255)+","+Math.min(Math.ceil(o[1]*l[1]+l[1]*h),255)+","+Math.min(Math.ceil(o[2]*l[2]+l[1]*h),255)}if(t.save(),void 0!==e.style.texture||void 0!==r.texture){var y,f,m,p,g,P,x=e.textures[void 0!==r.texture?r.texture:e.style.texture],b=function(e,i,r,o,a,n,s){var l=e[0][0],c=e[0][1],h=e[1][0],d=e[1][1],v=e[2][0],y=e[2][1];t.beginPath(),t.moveTo(l,c),t.lineTo(h,d),t.lineTo(v,y),t.closePath(),t.clip();var f=f=1/(i*(s-a)-o*s+n*a+(o-n)*r),m=-(r*(v-h)-a*v+s*h+(a-s)*l)*f,p=(a*y+r*(d-y)-s*d+(s-a)*c)*f,g=(i*(v-h)-o*v+n*h+(o-n)*l)*f,P=-(o*y+i*(d-y)-n*d+(n-o)*c)*f,b=(i*(s*h-a*v)+r*(o*v-n*h)+(n*a-o*s)*l)*f,w=(i*(s*d-a*y)+r*(o*y-n*d)+(n*a-o*s)*c)*f;t.transform(m,p,g,P,b,w),t.globalAlpha=u,t.drawImage(x,0,0)};if(null!==c){var w=.3*o[0]+.6*o[1]+.1*o[2];w>1&&(w=1),t.fillStyle="rgba("+c+","+(1-w).toFixed(3)+")"}if(3===s.length){y=0,f=0,m=x.width,p=0,g=x.width,P=x.height,void 0!==r.uvs&&(y=x.width*r.uvs[0],f=x.height*r.uvs[1],m=x.width*r.uvs[2],p=x.height*r.uvs[3],g=x.width*r.uvs[4],P=x.height*r.uvs[5]);var M=this.inflatePolygon(s,a,.5);b.call(this,M,y,f,m,p,g,P),null!==c&&t.fill()}else if(4===s.length){y=0,f=0,m=x.width,p=0,g=x.width,P=x.height,void 0!==r.uvs&&(y=x.width*r.uvs[0],f=x.height*r.uvs[1],m=x.width*r.uvs[2],p=x.height*r.uvs[3],g=x.width*r.uvs[4],P=x.height*r.uvs[5]),t.save(),M=this.inflatePolygon(s.slice(0,3),a,.5),b.call(this,M,y,f,m,p,g,P),t.restore(),y=x.width,f=x.height,m=0,p=x.height,g=0,P=0,void 0!==r.uvs&&(y=x.width*r.uvs[4],f=x.height*r.uvs[5],m=x.width*r.uvs[6],p=x.height*r.uvs[7],g=x.width*r.uvs[0],P=x.height*r.uvs[1]),t.save();var _=new Array(3);if(_[0]=s[2],_[1]=s[3],_[2]=s[0],M=this.inflatePolygon(_,a,.5),b.call(this,M,y,f,m,p,g,P),t.restore(),null!==c){M=this.inflatePolygon(s,a,.75),t.beginPath(),t.moveTo(M[0][0],M[0][1]),v=1;for(var z=M.length;v<z;v++)t.lineTo(M[v][0],M[v][1]);t.closePath(),t.globalAlpha=u,t.fill()}}}else{if("inflate"===e.style.fillmode){for(M=this.inflatePolygon(s,a,.5),t.beginPath(),t.moveTo(M[0][0],M[0][1]),v=1,z=s.length;v<z;v++)t.lineTo(M[v][0],M[v][1]);t.closePath()}else{for(t.beginPath(),t.moveTo(a[s[0]][0],a[s[0]][1]),v=1;v<s.length;v++)t.lineTo(a[s[v]][0],a[s[v]][1]);t.closePath()}switch(c="rgba("+c+","+u+")",e.style.fillmode){case"fill":case"inflate":t.fillStyle=c,t.fill();break;case"filltwice":t.fillStyle=c,t.fill(),t.fill();break;case"fillstroke":t.fillStyle=c,t.fill(),t.strokeStyle=c,t.stroke();break;case"hiddenline":t.strokeStyle=c,t.stroke()}}t.restore()}}}),Phoria.SoftwareRenderer=function(t){return Phoria.SoftwareRenderer.superclass.constructor.call(this),this.canvas=t,this.ctx=t.getContext("2d"),this._imagedata=this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height),this._data=this._imagedata.data,this},Phoria.Util.extend(Phoria.SoftwareRenderer,Phoria.Renderer,{canvas:null,ctx:null,_imagedata:null,_data:null,render:function(t){this.sortObjects(t),this.clearCanvasRect(0,0,this.canvas.width,this.canvas.height);for(var e,i=0;i<t.renderlist.length;i++)if("solid"===(e=t.renderlist[i]).style.drawmode)for(var r=0;r<e.polygons.length;r++)this.renderPolygon(null,e,t,e.polygons[r]);this.ctx.putImageData(this._imagedata,0,0,0,0,this.canvas.width,this.canvas.height)},clearCanvasRect:function(t,e,i,r){for(var o=4*(t+e*this.canvas.width-1)+3,a=4*(this.canvas.width-(i-t)),n=this._data,s=e;s<r;s++){for(var l=t;l<i;l++)n[o+=4]=0;o+=a}},renderPolygon:function(t,e,i,r){for(var o=e._coords,a=e._clip,n=r.vertices,s=r.color?r.color:e.style.color,l=1,c=0;c<n.length;c++)l&=a[n[c]];if(l)return!1;if(e.style.doublesided||!(o[n[0]][0]*o[n[1]][1]-o[n[1]][0]*o[n[0]][1]+(o[n[1]][0]*o[n[2]][1]-o[n[2]][0]*o[n[1]][1])+(o[n[2]][0]*o[n[0]][1]-o[n[0]][0]*o[n[2]][1])<0)){var h;switch(e.style.shademode){case"plain":(h=new Array(3))[0]=s[0],h[1]=s[1],h[2]=s[2];break;case"lightsource":(h=this.calcNormalBrightness(Phoria.Util.averagePolyVertex(n,e._worldcoords),r._worldnormal,i,e))[0]=Math.ceil(Math.min(h[0]*s[0],255)),h[1]=Math.ceil(Math.min(h[1]*s[1],255)),h[2]=Math.ceil(Math.min(h[2]*s[2],255))}return this.drawTriangle(o[n[2]][0],o[n[2]][1],o[n[1]][0],o[n[1]][1],o[n[0]][0],o[n[0]][1],h[0],h[1],h[2]),4===n.length&&this.drawTriangle(o[n[0]][0],o[n[0]][1],o[n[3]][0],o[n[3]][1],o[n[2]][0],o[n[2]][1],h[0],h[1],h[2]),!0}},drawTriangle:function(t,e,i,r,o,a,n,s,l){var c=(t=Math.round(16*t))-(i=Math.round(16*i)),h=i-(o=Math.round(16*o)),u=o-t,d=(e=Math.round(16*e))-(r=Math.round(16*r)),v=r-(a=Math.round(16*a)),y=a-e,f=c<<4,m=h<<4,p=u<<4,g=d<<4,P=v<<4,x=y<<4,b=this.canvas.width,w=this.canvas.height,M=this._data,_=Math.max(Math.min(t,i,o)+15>>4,0),z=Math.min(Math.max(t,i,o)+15>>4,b),E=Math.max(Math.min(e,r,a)+15>>4,0),S=Math.min(Math.max(e,r,a)+15>>4,w);if(!(z<=_||S<=E)){var R=d*t-c*e,U=v*i-h*r,A=y*o-u*a;(d<0||0==d&&c>0)&&R++,(v<0||0==v&&h>0)&&U++,(y<0||0==y&&u>0)&&A++;for(var V,k,T,H,L,I=R+c*(E<<4)-d*(_<<4),B=U+h*(E<<4)-v*(_<<4),O=A+u*(E<<4)-y*(_<<4),C=E;C<S;C++){for(V=I,k=B,T=O,H=_;H<z;H++)V>0&&k>0&&T>0&&(M[L=H+C*b<<2]=n,M[L+1]=s,M[L+2]=l,M[L+3]=255),V-=g,k-=P,T-=x;I+=f,B+=m,O+=p}}}}),Phoria.View={},Phoria.View.events={},Phoria.View.addMouseEvents=function(t,e){if(t.id){var i={velocityH:0,velocityLastH:0,positionX:0,clickPositionX:0,velocityV:0,velocityLastV:0,positionY:0,clickPositionY:0};return Phoria.View.events[t.id]=i,i.onMouseMove=function(t){i.positionX=t.clientX,i.velocityH=i.velocityLastH+.5*(i.positionX-i.clickPositionX),i.positionY=t.clientY,i.velocityV=i.velocityLastV+.5*(i.positionY-i.clickPositionY)},i.onMouseUp=function(e){t.removeEventListener("mousemove",i.onMouseMove,!1)},i.onMouseOut=function(e){t.removeEventListener("mousemove",i.onMouseMove,!1)},i.onMouseDown=function(e){e.preventDefault(),t.addEventListener("mousemove",i.onMouseMove,!1),i.clickPositionX=e.clientX,i.velocityLastH=i.velocityH,i.clickPositionY=e.clientY,i.velocityLastV=i.velocityV},t.addEventListener("mousedown",i.onMouseDown,!1),t.addEventListener("mouseup",i.onMouseUp,!1),t.addEventListener("mouseout",i.onMouseOut,!1),e&&t.addEventListener("click",e,!1),i}},Phoria.View.removeMouseEvents=function(t,e){if(t.id){var i=Phoria.View.events[t.id];i&&(t.removeEventListener("mousemove",i.onMouseMove,!1),t.removeEventListener("mousedown",i.onMouseDown,!1),t.removeEventListener("mouseup",i.onMouseUp,!1),t.removeEventListener("mouseout",i.onMouseOut,!1),e&&t.removeEventListener("click",e,!1),Phoria.View.events[t.id]=null)}},Phoria.View.getMouse=function(t){return Phoria.View.events[t.id]},Phoria.View.calculateClickPointAndVector=function(t,e,i){var r=vec3.fromValues(t.camera.lookat.x,t.camera.lookat.y,t.camera.lookat.z),o=vec3.subtract(vec3.create(),t._cameraPosition,r),a=t.viewport.height/2/(vec3.length(o)*Math.tan(t.perspective.fov/180*Math.PI/2)),n=vec2.fromValues(e-t.viewport.width/2,i-t.viewport.height/2);vec2.subtract(n,n,new vec2.fromValues(8,8));var s=vec2.create();vec2.scale(s,n,1/a);var l=vec3.fromValues(t.camera.up.x,t.camera.up.y,t.camera.up.z),c=vec3.create();vec3.cross(c,o,l),vec3.normalize(c,c);var h=vec3.scaleAndAdd(vec3.create(),r,c,s[0]),u=vec3.create();vec3.cross(u,c,o),vec3.normalize(u,u),vec3.scale(u,u,s[1]),vec3.subtract(h,h,u);var d=vec3.add(vec3.create(),r,o);return{clickPoint:h,clickVector:vec3.subtract(vec3.create(),h,d)}},Phoria.View.getIntersectedObjects=function(t,e,i){for(var r,o,a,n,s=[],l=t.renderlist,c=0;c<l.length;c++)if("solid"===(n=l[c]).style.drawmode)for(var h=0;h<n.polygons.length;h++)if(r=vec3.clone(n.polygons[h]._worldnormal),o=vec3.clone(n._worldcoords[n.polygons[h].vertices[0]]),null!==(a=Phoria.Util.planeLineIntersection(r,o,i,e))&&Phoria.Util.intersectionInsidePolygon(n.polygons[h],n._worldcoords,a)){var u={entity:n,polygonIndex:h,intersectionPoint:a};s.push(u)}for(var d=0;d<s.length;d++)s[d].distance=vec3.distance(t._cameraPosition,s[d].intersectionPoint);for(d=0;d<s.length-1;d++)for(var v,y=d+1;y<s.length;y++)s[d].distance>=s[y].distance&&(v=s[y],s[y]=s[d],s[d]=v);return s};
